<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mario-like 2D Platformer</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #6b8cff; touch-action: manipulation; }
        canvas { display: block; image-rendering: pixelated; }
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            box-sizing: border-box;
            z-index: 10;
        }
        .btn {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            user-select: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }
        #jumpBtn { background: rgba(0,200,0,0.6); }
        #score {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px black;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="score">Coins: 0</div>
    <canvas id="game"></canvas>
    
    <div id="controls">
        <div class="btn" id="leftBtn">◄</div>
        <div class="btn" id="rightBtn">►</div>
        <div class="btn" id="jumpBtn">↑</div>
    </div>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        // Responsive canvas
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        // Game constants
        const GRAVITY = 0.5;
        const JUMP_POWER = -12;
        const MOVE_SPEED = 5;
        const WORLD_WIDTH = 3000;

        // Player
        const player = {
            x: 100,
            y: 200,
            width: 40,
            height: 60,
            velX: 0,
            velY: 0,
            jumping: false,
            grounded: false,
            color: '#FF0000'
        };

        // Platforms
        const platforms = [
            {x: 0, y: 400, width: 800, height: 200},
            {x: 900, y: 350, width: 300, height: 20},
            {x: 1300, y: 300, width: 400, height: 20},
            {x: 1800, y: 250, width: 200, height: 20},
            {x: 2100, y: 380, width: 500, height: 20},
            {x: 2700, y: 300, width: 300, height: 20},
            {x: 800, y: 400, width: 2000, height: 200}
        ];

        // Coins
        let coins = [
            {x: 500, y: 300, collected: false},
            {x: 1000, y: 280, collected: false},
            {x: 1150, y: 280, collected: false},
            {x: 1300, y: 280, collected: false},
            {x: 1500, y: 220, collected: false},
            {x: 1900, y: 170, collected: false},
            {x: 2300, y: 300, collected: false},
            {x: 2450, y: 300, collected: false},
            {x: 2600, y: 300, collected: false}
        ];

        // Enemies
        let enemies = [
            {x: 1200, y: 340, width: 40, height: 40, velX: -1, alive: true},
            {x: 1600, y: 240, width: 40, height: 40, velX: 2, alive: true},
            {x: 2200, y: 340, width: 40, height: 40, velX: -1.5, alive: true}
        ];

        let cameraX = 0;
        let score = 0;
        const scoreEl = document.getElementById('score');

        // Touch controls
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const jumpBtn = document.getElementById('jumpBtn');

        let keys = { left: false, right: false, jump: false };

        leftBtn.addEventListener('touchstart', e => { e.preventDefault(); keys.left = true; });
        leftBtn.addEventListener('touchend', e => { e.preventDefault(); keys.left = false; });
        rightBtn.addEventListener('touchstart', e => { e.preventDefault(); keys.right = true; });
        rightBtn.addEventListener('touchend', e => { e.preventDefault(); keys.right = false; });
        jumpBtn.addEventListener('touchstart', e => { e.preventDefault(); keys.jump = true; });

        // Keyboard fallback
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') keys.left = true;
            if (e.key === 'ArrowRight') keys.right = true;
            if (e.key === ' ') keys.jump = true;
        });
        document.addEventListener('keyup', e => {
            if (e.key === 'ArrowLeft') keys.left = false;
            if (e.key === 'ArrowRight') keys.right = false;
            if (e.key === ' ') keys.jump = false;
        });

        // === FIXED AUDIO SYSTEM (Mobile-Safe) ===
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // Unlock audio on first user interaction
        document.addEventListener('touchstart', initAudio, { once: true });
        document.addEventListener('click', initAudio, { once: true });

        function playCoinSound() {
            if (!audioCtx) return;

            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            osc.type = 'square';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);

            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);

            osc.start(now);
            osc.stop(now + 0.1);
        }
        // === End Audio Fix ===

        // Collision
        function collides(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        // Game loop update
        function update() {
            if (keys.left) player.velX = -MOVE_SPEED;
            else if (keys.right) player.velX = MOVE_SPEED;
            else player.velX = 0;

            if (keys.jump && player.grounded) {
                player.velY = JUMP_POWER;
                player.grounded = false;
                keys.jump = false;
            }

            player.velY += GRAVITY;
            player.x += player.velX;
            player.y += player.velY;

            player.grounded = false;

            for (let p of platforms) {
                if (collides(player, p)) {
                    if (player.velY > 0 && player.y < p.y) {
                        player.y = p.y - player.height;
                        player.velY = 0;
                        player.grounded = true;
                    }
                    else if (player.velY < 0) {
                        player.y = p.y + p.height;
                        player.velY = 0;
                    }
                    else if (player.velX > 0) player.x = p.x - player.width;
                    else if (player.velX < 0) player.x = p.x + p.width;
                }
            }

            if (player.y > canvas.height) {
                player.x = 100;
                player.y = 200;
                player.velX = player.velY = 0;
            }

            cameraX = Math.max(0, Math.min(WORLD_WIDTH - canvas.width, player.x - canvas.width / 3));

            // Coins
            coins.forEach(coin => {
                if (!coin.collected && collides(player, {x: coin.x, y: coin.y, width: 40, height: 40})) {
                    coin.collected = true;
                    score++;
                    scoreEl.textContent = `Coins: ${score}`;
                    playCoinSound();
                }
            });

            // Enemies
            enemies.forEach(enemy => {
                if (!enemy.alive) return;
                enemy.x += enemy.velX;

                let onPlatform = false;
                for (let p of platforms) {
                    if (enemy.x >= p.x && enemy.x + enemy.width <= p.x + p.width && 
                        Math.abs(enemy.y + enemy.height - p.y) < 10) {
                        onPlatform = true;
                    }
                }
                if (!onPlatform || enemy.x < 0 || enemy.x > WORLD_WIDTH) {
                    enemy.velX = -enemy.velX;
                }

                if (collides(player, enemy) && player.velY > 0 && player.y < enemy.y) {
                    enemy.alive = false;
                    player.velY = JUMP_POWER / 1.5;
                    score += 10;
                    scoreEl.textContent = `Coins: ${score}`;
                }
                else if (collides(player, enemy)) {
                    player.x = 100; player.y = 200;
                    score = Math.max(0, score - 5);
                    scoreEl.textContent = `Coins: ${score}`;
                }
            });
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, '#6b8cff');
            grad.addColorStop(1, '#a0c4ff');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-cameraX, 0);

            // Platforms
            ctx.fillStyle = '#8B4513';
            platforms.forEach(p => {
                ctx.fillRect(p.x, p.y, p.width, p.height);
                ctx.fillStyle = '#228B22';
                ctx.fillRect(p.x, p.y - 10, p.width, 10);
                ctx.fillStyle = '#8B4513';
            });

            // Coins
            coins.forEach(coin => {
                if (!coin.collected) {
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(coin.x + 20, coin.y + 20, 18, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#FFA500';
                    ctx.beginPath();
                    ctx.arc(coin.x + 20, coin.y + 20, 12, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            // Enemies
            enemies.forEach(enemy => {
                if (enemy.alive) {
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                    ctx.fillStyle = 'white';
                    ctx.fillRect(enemy.x + 8, enemy.y + 10, 8, 8);
                    ctx.fillRect(enemy.x + 24, enemy.y + 10, 8, 8);
                    ctx.fillStyle = 'black';
                    ctx.fillRect(enemy.x + 10, enemy.y + 12, 4, 4);
                    ctx.fillRect(enemy.x + 26, enemy.y + 12, 4, 4);
                }
            });

            // Player
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(player.x, player.y, player.width, player.height);
            ctx.fillStyle = '#FFDBB4';
            ctx.fillRect(player.x + 10, player.y + 5, 20, 20);
            ctx.fillStyle = '#0000FF';
            ctx.fillRect(player.x + 5, player.y + 25, 30, 15);
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(player.x, player.y - 10, player.width, 15);

            ctx.restore();
        }

        function loop() {
            update();
            render();
            requestAnimationFrame(loop);
        }

        loop();
    </script>
</body>
</html>